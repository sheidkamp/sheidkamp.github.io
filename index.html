<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<style> circle {fill: lightblue; stroke: black;} </style>
<body onload='init()'>
<div id="chart"></div>
<div id="summary"></div>
<div id="slideshow" align=center>
    <button id='btn_next' onClick="lastSlide()">Prev</button>
    <button id='btn_last' onClick="nextSlide()">Next</button>
    <br>
    <button id="btn_toggle_slideshow" onClick='toggleSlideshow()'>Switch to Interactive Mode</button>
</div>
<div id="filters" align=center>
    <table>
        <tr><td>
            School type<br>
            <input type="checkbox" name="type_all" checked>All<br>
            <input type="checkbox" name="type_public">Private<br>
            <input type="checkbox" name="type_private">Public<br>
        <td></td>
        </td></tr>
    </table>
</div>
<script>

const SLIDESHOW = 'slideshow';
const INTERACTIVE = 'interactive'

let mode = SLIDESHOW;

function toggleSlideshow() {
    const butn_toggle = document.getElementById("btn_toggle_slideshow");
    const btn_next = document.getElementById("btn_next");
    const btn_last = document.getElementById("btn_last");

    if (mode == SLIDESHOW) {
        mode = INTERACTIVE;
        butn_toggle.innerHTML = "Switch to Guided Mode";
        btn_next.disabled = true;
        btn_last.disabled = true;
    }
    else {
        mode = SLIDESHOW;
        butn_toggle.innerHTML = "Switch to Interactive Mode";
        updateSlide();
        btn_next.disabled = false;
        btn_last.disabled = false;
    }
}

/********************
 * 
 * Slideshow stuff
 * 
 *******************/
let slide_index = 0;

const SLIDES = [
    {
        year: 1964,
        text: "20 hours a week"
    },
    {
        year: 1975,
        text: "More expensive in the 70s"
    },
    {
        year: 1984,
        text: "Crazy 80s"
    },
    {
        year: 1992,
        text: "40 hours"
    },
    {
        year: 2016,
        text: "70 hours"
    }
];

function nextSlide() {
    if (slide_index < SLIDES.length-1) {
        slide_index++;
    }
    updateSlide();
}

function lastSlide() {
    if (slide_index > 0) {
        slide_index--;
    }
    updateSlide();
}

function updateSlide() {
    const slide = SLIDES[slide_index];
    console.log(slide.year)
    DrawChart(slide.year)
}



 /********************
 * 
 * Graph stuff
 * 
 *******************/
const COST_AXIS_COLOR = 'steelblue';

const config_defaults = {
    tick_format: x => x
};

const cost_deaults = {
    ...config_defaults,
    line_color: COST_AXIS_COLOR
}

const wage_config = {
    ...config_defaults,
    type: "wage",
    name: 'minimum_wage',
    field: "MinimumWage",
    label: (val) => {return '$' + parseFloat(val).toFixed(2)},
    color: 'green',
    axis: d3.axisRight,
    tick_format: (a) => {return '$'+ parseFloat(a).toFixed(2)},
};

const cost_configs = [
    {
        ...cost_deaults,
        type: "cost",
        name: "all costs",
        field: "AllCosts",
        label: (val) => {return '$' + parseInt(val)},
        color: "red",
        axis: d3.axisLeft,
        tick_format: (a) => {return '$'+ parseInt(a)}
    },

    {
        ...cost_deaults,
        type: "cost",
        name: "private costs",
        field: "PrivateAllCosts",
        label: (val) => {return '$' + parseInt(val)},
        color: "pink",
        axis: d3.axisLeft,
        tick_format: (a) => {return '$'+ parseInt(a)}
    }
];
    
// const cost_config = {
//     ...config_defaults,
//     name: "all costs",
//     field: "AllCosts",
//     label: (val) => {return '$' + parseInt(val)},
//     color: "red",
//     axis: d3.axisLeft,
//     tick_format: (a) => {return '$'+ parseInt(a)}
// };

// const cost_config_2 = {
//     ...config_defaults,
//     name: "private costs",
//     field: "PrivateAllCosts",
//     label: (val) => {return '$' + parseInt(val)},
//     color: "pink",
//     axis: d3.axisLeft,
//     tick_format: (a) => {return '$'+ parseInt(a)}
// };

const data_sets =  [wage_config, ...cost_configs];

var DATA_FIELD = "AllCosts";
const WAGE_FIELD = "MinimumWage";

var y = {};
var focus = {};
var y_axes = {};
var line_graphs = {};
var x_grid_lines = {};


var line;
var x;
var x_focus;

var summary = document.querySelector("#summary")
var margin = {top: 10, right: 30, bottom: 30, left: 60},
    width = 760 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;

let path;
let svg;
const formatTime = d3.timeFormat("%Y");
let college_costs;
const parseDate = d3.timeParse("%Y");


function updateDataField(new_field) {
    selectedData = college_costs[0];

    if( selectedData[new_field]) {
        DATA_FIELD = new_field;
        cost_config.field = new_field;

        
        data_sets.forEach((config) => {
            y_axes[config.name].remove();
            x_grid_lines[config.name].remove();
            line_graphs[config.name].remove();
            focus[config.name].remove();

        });

        y = {};
        y_axes = {};
        line_graphs = {};
        focus = {};
        x_grid_lines = {};


        setVisualElements();
    }
    else {
        console.log("Unknown field:", new_field);
    }
}

//
//
//
async function init() {
    college_costs =  await d3.csv( "https://sheidkamp.github.io/data/college/college_costs.csv");
    
    initializeVisualElements();
    setVisualElements();
    updateSlide();
}


//
//
//
function initializeVisualElements(){
    svg = d3.select("#chart")
        .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
        .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

    // Add X axis
    x = d3.scaleTime()
        .domain(d3.extent(college_costs, function(d) { return parseDate(d.Year); }))
        .range([ 0, width ]);
    svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x)
        .ticks(d3.timeYear.every(5))
        );

    // Add label/circle for year
    // Todo: put in style
    x_focus = svg
        .append('g')
        .append('circle')
        .style("fill", "#333")
        .attr("stroke", "black")
        .attr('r', 4)
        .style("opacity", 0.5);

    // Add Y axes
    line = svg
        .append('g')
        .append('line')
        .style("stroke", "lightgray")
        .style("stroke-width", 1);


    //
    //
    //.
    function mouseover() {

        if (mode != INTERACTIVE) {
            return;
        }
        data_sets.forEach((config) => {
            focus[config.name].style("opacity", 0.5);
        });

        x_focus.style("opacity", 0.5);
    }

    //
    //
    //
    function mousemove() {
        if (mode != INTERACTIVE) {
            return;
        }

        // recover coordinate we need
        var x0 = formatTime(
            x.invert(d3.mouse(this)[0])
        );

        DrawChart(x0);

    }

    // Create a rect on top of the svg area: this rectangle recovers mouse position
    svg
        .append('rect')
        .style("fill", "none")
        .style("pointer-events", "all")
        .attr('width', width)
        .attr('height', height)
        .on('mouseover', mouseover)
        .on('mousemove', mousemove);

}

//
//
//
function setVisualElements() {

    let ys = d3.scaleLinear()
        .domain([0, d3.max(college_costs, function(d) { return +d[wage_config.field]; })])
        .range([ height, 0 ]);

    // Specifically handle the axes:
    y_axes['wage'] = svg.append("g")
            .call(
                wage_config.axis(ys)
                    .tickFormat(wage_config.tick_format)
            )
            .attr("style","color:"+ wage_config.color+ ";");

    y['wage'] = ys;


    const cost_field_array = [];
    cost_configs.forEach((config) => {
        cost_field_array.push(config.field);
    });

    ys = d3.scaleLinear()
        .domain([0, d3.max(college_costs, function(d) {
            const values = [];
            cost_field_array.forEach((val) => {
                values.push(val);
            })

            return +d[d3.max(values)]; 
        })])
        .range([ height, 0 ]);

    y_axes['cost'] = svg.append("g")
        .call(
            d3.axisLeft(ys)
        )
        .attr("style","color:"+ COST_AXIS_COLOR+ ";");

    y['cost'] = ys;

    //
    data_sets.forEach((config) => {
        ys = y[config.type];

        x_grid_lines[config.name] = 
            svg.append('g')
            .append('line')
            .style("stroke", config.line_color || config.color)
            .style("stroke-width", 1)
            .style("opacity", 0.3);
            
            
        line_graphs[config.name] = svg
            .append("g")
            .append("path")
            .datum(college_costs)
            .attr("fill", "none")
            .attr("stroke", config.color)
            .attr("stroke-width", 1.5)
            .attr("d", d3.line()
                .x(function(d) { return x(parseDate(d.Year)) })
                .y(function(d) { return ys(d[config.field]) })
                )

        // Todo: put in style
        var f = svg
            .append('g')
            .append('circle')
            .style("fill", "#333")
            .attr("stroke", "black")
            .attr('r', 4)
            .style("opacity", 0.5);
        
        focus[config.name] = f;

    });

    
    svg.selectAll(".tick")
        .each(function (d) {
            if ( d === 0 ) {
                this.remove();
            }
        });

}


var bisect = d3.bisector(function(d) { return d.Year; }).left;


function DrawChartYear(year) {
    let x0 = x(parseDate(year));
    DrawChart(x0)
}

function generateSummary(selectedData) {
    const table_start = "<table><tr><td>Type</td><td>Cost</td><td>Minimum Wage</td><td>Hours</td></tr>";
    const table_end = "</table>";
    let table_rows = '';

    cost_configs.forEach((config) => {
        hours_worked = Math.round(selectedData[config.field] / selectedData[WAGE_FIELD]/52);
        table_rows += 
            "<tr><td>" + config.name +
            "</td><td>" + selectedData[config.field] + 
            "</td><td>" + selectedData[WAGE_FIELD] + 
            "</td><td>" + hours_worked + "</td></tr>";
    });

    let slide_text = '';

    if (mode == SLIDESHOW) {
        slide_text = SLIDES[slide_index].text + '<br>'
    }
    
    summary.innerHTML = slide_text + table_start + table_rows + table_end;
}

function DrawChart(x0) {
    var i = bisect(college_costs, x0, 1);
    selectedData = college_costs[i];

    generateSummary(selectedData)

    // Graphs
    data_sets.forEach((config) => {
        focus[config.name]
            .attr("cx", x(parseDate(selectedData.Year)))
            .attr("cy", y[config.type](selectedData[config.field]))
            .attr("stroke", 'black');

        // Horizontal grid markers:
        x_grid_lines[config.name]
            .attr("x1", 0)
            .attr("y1", y[config.type](selectedData[config.field]))
            .attr("x2", x(parseDate(selectedData.Year)))
            .attr("y2", y[config.type](selectedData[config.field]));
    });

    // Y-Axis
    x_focus
        .attr("cx", x(parseDate(selectedData.Year)))
        .attr("cy", height)
        .attr("stroke", 'black');

    line.attr("x1", x(parseDate(selectedData.Year)))
        .attr("y1", 0)
        .attr("x2", x(parseDate(selectedData.Year)))
        .attr("y2", height);

    console.log("ok")
}
</script>
</body>
</html>