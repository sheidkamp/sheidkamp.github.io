<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<style> 
 </style>
<body onload='init()'>
<div align = center width=500>
    <div id="chart" align=center></div>
    <div id="chart2" align=center></div>

    <div id="summary" align=center width=500></div>

    <div id="filters" width=500>
        <table>
            <tr valign="top"><td>
                School type<br>
                <input type="checkbox" id="type_all"  onclick="toggleGraph()">All<br>
                <input type="checkbox" id="type_public" checked onclick="toggleGraph()">Public<br>
                <input type="checkbox" id="type_private" onclick="toggleGraph()">Private<br>
            </td><td>
                Cost of<br>
                <input type="checkbox" id="cost_all" checked onclick="toggleGraph()">All Costs<br>
                <input type="checkbox" id="cost_tuition" onclick="toggleGraph()">Tution and Fees Only<br>
            </td></tr>
        </table>
    </div>
    <div id="slideshow" align=center width=500>
        <button id='btn_next' onClick="lastSlide()">Prev</button>
        <button id="btn_toggle_slideshow" onClick='toggleSlideshow()'>Stop Slideshow</button>
        <button id='btn_last' onClick="nextSlide()">Next</button>
        <br>
    
    </div>
</div>
<script>

const SLIDESHOW = 'slideshow';
const INTERACTIVE = 'interactive'

let mode = SLIDESHOW;

function toggleSlideshow() {
    
    let filtered_data = filterData();

    const butn_toggle = document.getElementById("btn_toggle_slideshow");
    const btn_next = document.getElementById("btn_next");
    const btn_last = document.getElementById("btn_last");

    if (mode == SLIDESHOW) {
        mode = INTERACTIVE;
        butn_toggle.innerHTML = "Restart Slideshow";
        btn_next.disabled = true;
        btn_last.disabled = true;
        target_year = SLIDES[SLIDES.length-1].year;
        //target_max_y = current_max_y;
        _setInterval('year_interval',animateYear, 20);
    }
    else {
        mode = SLIDESHOW;
        butn_toggle.innerHTML = "Stop Slideshow";
        slide_index=0;
        updateSlide(20);
        btn_next.disabled = false;
        btn_last.disabled = false;
    }
}

const intervals = {};
function _setInterval(name, action, speed) {
    //console.log("Setting interval", name);
    document.getElementById("btn_toggle_slideshow").disabled = true;
    document.getElementById("btn_next").disabled = true;
    document.getElementById("btn_last").disabled = true;

    intervals[name] = setInterval(action, speed);
}


function _clearInterval(name) {
    //console.log("clearing interval", intervals[name]);
    clearInterval(intervals[name]);
    delete intervals[name];

    if (Object.keys(intervals).length == 0) {
        document.getElementById("btn_toggle_slideshow").disabled = false;

        if (mode == SLIDESHOW) {
            document.getElementById("btn_next").disabled = false;
            document.getElementById("btn_last").disabled = false;
        }
    }
}


const graph_colors = {
    AllAllCosts: 'Yellow',
    PrivateAllCosts: 'DarkOrange',
    PublicAllCosts: 'RoyalBlue',
    AllTuitionAndFees: 'Khaki',
    PrivateTuitionAndFees: 'LightSalmon',
    PublicTuitionAndFees: 'LightBlue'
};

const display_names = {
    AllAllCosts: 'Public and Privates Colleges, All Costs',
    PrivateAllCosts: 'CollegePrivate , All Costs',
    PublicAllCosts: 'Public College, All Costs',
    AllTuitionAndFees: 'Public and Privates Colleges, Tuition and Fees',
    PrivateTuitionAndFees: 'Private College, Tuition and Fees',
    PublicTuitionAndFees: 'Public College, Tuition and Fees'
};

const axis_names = {
    AllAllCosts: 'All Colleges',
    PrivateAllCosts: 'Private College',
    PublicAllCosts: 'Public College',
    AllTuitionAndFees: 'All Colleges',
    PrivateTuitionAndFees: 'Private College',
    PublicTuitionAndFees: 'Public College',
    minimum_wage: 'Minimum Wage'
}

const axis_names_2 = {
    AllAllCosts: 'All Costs',
    PrivateAllCosts: 'All Costs',
    PublicAllCosts: 'All Costs',
    AllTuitionAndFees: 'Tuition and Fees',
    PrivateTuitionAndFees: 'Tuition and Fees',
    PublicTuitionAndFees: 'Tuition and Fees',
    minimum_wage: ''
}


function toggleGraph(updateVisuals = true) {
    school_types = {
        type_all: 'All',
        type_private: 'Private',
        type_public: 'Public'
    };

    cost_types = {
        cost_all: 'AllCosts',
        cost_tuition: 'TuitionAndFees'
    };

    const btn_values = {};
    Object.keys({...school_types, ...cost_types}).forEach((name) => {
        btn_values[name] = document.getElementById(name).checked;
    });

    clearVisualElements();
    
    cost_configs = [];
    data_sets =  [wage_config];

    Object.keys(school_types).forEach((school_type) => {
        Object.keys(cost_types).forEach((cost_type) => {
            if (!btn_values[school_type] || !btn_values[cost_type]) {
                return;
            }

            let fieldname = school_types[school_type] + cost_types[cost_type];
            const config = {
                ...cost_defaults,
                type: "cost",
                name: fieldname,
                field: fieldname,
                label: (val) => {return '$' + parseInt(val)},
                color: graph_colors[fieldname],
                display_name: display_names[fieldname],
                axis: d3.axisLeft,
                //tick_format: (a) => {return '$'+ parseInt(a)},
                tick_format: (a) => {return '$'+ parseFloat(a).toFixed(2)}
            }

            cost_configs.push(config);
            data_sets.push(config);

        });
    });

    if(updateVisuals) {
        setVisualElements();
        if(mode==SLIDESHOW) {
            drawChart(SLIDES[slide_index].year)
        }
    }


}

/********************
 * 
 * Slideshow stuff
 * 
 *******************/
let slide_index = 0;

const SLIDES = [
    {
        year: 1968,
        text: "20 hours a week"
    },
    {
        year: 1975,
        text: "More expensive in the 70s"
    },
    {
        year: 1984,
        text: "Crazy 80s"
    },
    {
        year: 1992,
        text: "40 hours"
    },
    {
        year: 2005,
        text: "40 hours"
    },
    {
        year: 2019,
        text: "70 hours"
    }
];

let year_interval;
let current_year = SLIDES[slide_index].year;
let target_year;

let y_axis_interval;
let target_max_y;
let current_max_y = 1;
let max_y_animate_direction = "";
let color_range;

function nextSlide() {
    if (slide_index < SLIDES.length-1) {
        slide_index++;
    }
    updateSlide();
}

function lastSlide() {
    if (slide_index > 0) {
        slide_index--;
    }
    updateSlide();
}

function updateSlide(speed=50) {
    const slide = SLIDES[slide_index];

    target_year = slide.year;
    _setInterval("year_interval", animateYear, speed);
}


function animateYear() {
    //console.log(target_year, current_year);
    if(target_year > current_year) {
        current_year++;
    }
    else if (target_year < current_year) {
        current_year--  ;
    }
    else {
        _clearInterval("year_interval");
    }
    clearVisualElements();
    setVisualElements();
    drawChart(current_year);
    
}


 /********************
 * 
 * Graph stuff
 * 
 *******************/
const COST_AXIS_COLOR = 'steelblue';

const config_defaults = {
    tick_format: x => x
};

const cost_defaults = {
    ...config_defaults,
    line_color: COST_AXIS_COLOR
}

const formatDollar = (a) => {return '$'+ parseFloat(a).toFixed(2)};
const formatDollarWhole = (a) => {return '$'+ parseFloat(a).toFixed(0)};

const wage_config = {
    ...config_defaults,
    type: "wage",
    name: 'minimum_wage',
    field: "MinimumWage",
    label: formatDollar,
    color: 'green',
    axis: d3.axisRight,
    tick_format: formatDollar,
};


let data_sets = [];

var y = {};
var focus = {};
var y_axes = {};
var line_graphs = {};
var x_grid_lines = {};
var line_labels = {};

var line;
var x;
var x_focus;

var x2;
var y2;

// Chart2 section
let y_axis2;
let graph2;

var summary = document.querySelector("#summary")
var margin = {top: 40, right: 90, bottom: 30, left: 60};
var width = 820 - margin.left - margin.right;
var height = 410 - margin.top - margin.bottom;
var height2 = 180 - margin.top - margin.bottom;

let path;
let svg;
let svg2;

let college_costs;
let display_college_costs;

const parseDate = d3.timeParse("%Y");
const formatTime = d3.timeFormat("%Y");


function clearVisualElements() {
    data_sets.forEach((config) => {
        x_grid_lines[config.name].remove();
        line_graphs[config.name].remove();
        focus[config.name].remove();
    });

    if ( y_axes["cost"]) { y_axes["cost"].remove(); }
    if ( y_axes["wage"]) { y_axes["wage"].remove(); }
    if (y_axis2) {y_axis2.remove(); }
    if (graph2) {graph2.remove();}

    y = {};
    line_graphs = {};
    focus = {};
    x_grid_lines = {};
  
    // We need to redraw axis labels, so remove them
    svg.selectAll(".line-label").remove();

}


async function init() {
    college_costs =  await d3.csv( "https://sheidkamp.github.io/data/college/college_costs.csv");
    
    initializeVisualElements();
    toggleGraph(false);
    setVisualElements();
    updateSlide();
    
}


function initializeVisualElements(){
    svg = d3.select("#chart")
        .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
        .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

    svg2 = d3.select("#chart2")
        .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height2 + margin.top + margin.bottom)
        .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

    // Add X axis
    x = d3.scaleTime()
        .domain(d3.extent(college_costs, function(d) { return parseDate(d.Year); }))
        .range([ 0, width ]);

  
    x2 = d3.scaleBand()
        .domain(d3.map(college_costs, function(d){return d.Year;}).keys())
        .range([0, width])
        .padding(0);


    svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x)
            .ticks(d3.timeYear.every(5))
        );

    svg2.append("g")
        .attr("transform", "translate(0," + height2 + ")")
        .call(d3.axisBottom(x2)
            .tickValues(x2.domain().filter(function(d,i){ return !(d%5)}))
        );


    y2 = d3.scaleLinear()
        .domain([0, 80])
        .range([ height2, 0 ]);

    // gridlines in y axis function
    function make_y_gridlines(yy) {		
        return d3.axisLeft(yy)
            .ticks(8)
    }

    svg2.append("g")			
      .call(make_y_gridlines(y2)
          .tickSize(-width)
          .tickFormat("")
      )
      .attr("style","color:lightgray");
      

    // Add label/circle for year
    x_focus = svg
        .append('g')
        .append('circle')
        .style("fill", "#333")
        .attr("stroke", "black")
        .attr('r', 4)
        .style("opacity", 0.5);

    // Add guideline
    line = svg
        .append('g')
        .append('line')
        .style("stroke", "lightgray")
        .style("stroke-width", 1);


    //
    color_range = d3.scaleLinear().domain([10,60]).range(['green','red']);

    function mouseover() {

        if (mode != INTERACTIVE) {
            return;
        }
        data_sets.forEach((config) => {
            focus[config.name].style("opacity", 0.5);
        });

        //x_focus.style("opacity", 0.5);
    }

    function mousemove() {
        if (mode != INTERACTIVE) {
            return;
        }

        // recover coordinate we need
        var x0 = formatTime(
            x.invert(d3.mouse(this)[0])
        );

        
        drawChart(x0);

    }

    // X Axis labels:
    svg.append("text")             
        .attr("transform",
                "translate(" + (width/2) + " ," + 
                            (height + margin.bottom ) + ")")
        .style("text-anchor", "middle")
        .text("Year");

    svg2.append("text")             
        .attr("transform",
                "translate(" + (width/2) + " ," + 
                            (height2 + margin.bottom) + ")")
        .style("text-anchor", "middle")
        .text("Year");

    // text label for the y axis
    svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.left)
        .attr("x",0 - (2*height / 3))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .style("fill", "steelblue")
        .text("Cost/year");

    svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.left)
        .attr("x",0 - (height / 3))
        .attr("dy", "1em")
        .style("fill", wage_config.color)
        .style("text-anchor", "middle")
        .text("dollars/hr"); 

    svg2.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.left + 10)
        .attr("x",0 - (height2 / 2))
        .attr("dy", "1em")
        .style("fill", "steelblue")
        .style("text-anchor", "middle")
        .text("hrs/week"); 


    svg.append("text")             
        .attr("transform",
                "translate(" + (width/2) + " ," + 
                            (-20) + ")")
        .style("text-anchor", "middle")
        .text("Federal Minimum Wage and the Cost of College");

    svg2.append("text")             
        .attr("transform",
                "translate(" + (width/2) + " ," + 
                            (-20) + ")")
        .style("text-anchor", "middle")
        .text("Hours per week at minimum wage to pay for college");

    // Graph titles

    // Create a rect on top of the svg area: this rectangle recovers mouse position
    svg
        .append('rect')
        .style("fill", "none")
        .style("pointer-events", "all")
        .attr('width', width)
        .attr('height', height)
        .on('mouseover', mouseover)
        .on('mousemove', mousemove);

    svg2
        .append('rect')
        .style("fill", "none")
        .style("pointer-events", "all")
        .attr('width', width)
        .attr('height', height2)
        .on('mouseover', mouseover)
        .on('mousemove', mousemove);

}

//
//
//
function setVisualElements() {

    let filtered_data = filterData();

    target_max_y = d3.max(filterData(), function(d) {
            const cost_field_array = [];
            cost_configs.forEach((config) => {
                cost_field_array.push(config.field);
            });
            const values = [];
            //console.log(d)
            cost_field_array.forEach((val) => {
                values.push(parseInt(d[val]));
            })

            values.push(1000*parseFloat(d["MinimumWage"]))

            //console.log("Max out of", values)
            return d3.max(values); 
        });
    

    let ys = d3.scaleLinear()
        .domain([0, 0.001 * target_max_y])
        .range([ height, 0 ]);

    y['wage'] = ys;


    y_axes['wage'] = svg.append("g")
            .call(
                wage_config.axis(ys)
                    .tickFormat(wage_config.tick_format)
            )
           .attr("style","color:"+ wage_config.color + ";");



    ys = d3.scaleLinear()
        .domain([0, target_max_y])
        .range([ height, 0 ]);


    y_axes['cost'] = svg.append("g")
        .call(
            d3.axisLeft(ys)
            .tickFormat(formatDollarWhole)
        )
        .attr("style","color:"+ COST_AXIS_COLOR+ ";");

    y['cost'] = ys;

    
    // draw the line graphs
    data_sets.forEach((config) => {
        ys = y[config.type];

        x_grid_lines[config.name] = 
            svg.append('g')
            .append('line')
            .style("stroke", config.line_color || config.color)
            .style("stroke-width", 1)
            .style("opacity", 0.3);
            

        let last_x, last_y;

        line_graphs[config.name] = svg
            .append("g")
            .append("path")
            .datum(filtered_data)
            .attr("fill", "none")
            .attr("stroke", config.color)
            .attr("stroke-width", 1.5)
            .attr("d", d3.line()
                .x(function(d) { last_x = x(parseDate(d.Year)); return last_x })
                .y(function(d) { last_y = ys(d[config.field]); return last_y; })
                );

        console.log(last_x, last_y);
        last_x = d3.max([last_x,30]);
        svg.append("text")
            .attr("class", "line-label")
            .attr("transform", "translate(" + (last_x + 5) + "," + last_y + ")")
            .attr("dy", ".15em")
            .attr("text-anchor", "start")
            .style("fill", config.color)
            .style("font-size","10px")
            .text(axis_names[config.name]);

        svg.append("text")
            .attr("class", "line-label")
            .attr("transform", "translate(" + (last_x + 5) + "," + (last_y + 10) + ")")
            .attr("dy", ".15em")
            .attr("text-anchor", "start")
            .style("fill", config.color)
            .style("font-size","10px")
            .text(axis_names_2[config.name]);

        var f = svg
            .append('g')
            .append('circle')
            .style("fill", "#333")
            .attr("stroke", "black")
            .attr('r', 4)
            .style("opacity", 0.5);
        
        focus[config.name] = f;

    });

    // Little chart

    y_axis2 = svg2.append("g")
        .call(
            d3.axisLeft(y2)
        )
        .attr("style","color:"+ COST_AXIS_COLOR+ ";");

    let MAIN_FIELD = 'PublicAllCosts';

    graph2 = svg2.append("g")
        .selectAll("rect")
        .data(filtered_data)
        .join("rect")
        .attr("x", (d, i) => {return x2(d.Year)})
        .attr("y", (d,i) => { return y2( (1.0*d[MAIN_FIELD]) / (52.0*d["MinimumWage"]))})
        .attr("height", (d,i) => { return height2-y2( (1.0*d[MAIN_FIELD]) / (52.0*d["MinimumWage"])) })
        .attr("width", (d) => {return x2.bandwidth();} )
        .attr("fill", (d) => {
            if (mode == SLIDESHOW) {
                if ( d.Year == filtered_data[filtered_data.length - 1].Year) {
                    return "orange";
                }
            }
            else {
                // find and highlight the "selected one"
            }

            return color_range((1.0*d[MAIN_FIELD]) / (52.0*d["MinimumWage"]));
        })

    svg.selectAll(".tick")
        .each(function (d) {
            if ( d === 0 ) {
                this.remove();
            }
        });

        console.log("Done")

}


var bisect = d3.bisector(function(d) { return d.Year; }).left;


function drawChartYear(year) {
    let x0 = x(parseDate(year));
    drawChart(x0)
}

function generateSummary(selectedData) {
    const table_data = [];

    const table_start = "<table border=1>";
    const table_end = "</table>";
    let table_rows = '';


    const rows = [
        {name: 'Cost', value: (d, c) => {return formatDollarWhole(d[c.field]) }},
        {name: 'Minimum Wage', value: (d, c) => {return formatDollar(d[wage_config.field]) + "/hr" }},
        {name: 'Hours Per Week', value: (d, c) => {return Math.round(d[c.field] / d[wage_config.field]/52.0) }},
    ];

    rows.forEach((row) => {
        table_rows += "<tr><td>"+ row.name + "</td>";

        cost_configs.forEach((config) => {
            table_rows += "<td bgcolor='" + config.color + "'>" + row.value(selectedData, config) + "</td>"
        });

        table_rows += "</tr>";

    });

    let slide_text = '';

    if (mode == SLIDESHOW) {
        slide_text = SLIDES[slide_index].text + '<br>'
    }
    
    summary.innerHTML = slide_text + table_start + table_rows + table_end;
}


function drawChart(x0) {
    var i = bisect(college_costs, x0, 1);
    selectedData = college_costs[i];

    generateSummary(selectedData)

    // horizontal guidelines and circles at graph interscetions
    data_sets.forEach((config) => {
        focus[config.name]
            .attr("cx", x(parseDate(selectedData.Year)))
            .attr("cy", y[config.type](selectedData[config.field]))
            .attr("stroke", 'black');

        // Horizontal grid markers:
        x_grid_lines[config.name]
            .attr("x1", 0)
            .attr("y1", y[config.type](selectedData[config.field]))
            .attr("x2", x(parseDate(selectedData.Year)))
            .attr("y2", y[config.type](selectedData[config.field]));
    });


    x_focus
        .attr("cx", x(parseDate(selectedData.Year)))
        .attr("cy", height)
        .attr("stroke", 'black');

    line.attr("x1", x(parseDate(selectedData.Year)))
        .attr("y1", 0)
        .attr("x2", x(parseDate(selectedData.Year)))
        .attr("y2", height);

    // Little graph

    console.log("ok")

}


function filterData() {
    if (mode == INTERACTIVE && current_year == target_year) {
        return college_costs;
    }

    const filter_by_year = (row) => { return row.Year <= current_year}
    return college_costs.filter(filter_by_year);

}

</script>
</body>
</html>